# ì•Œë¼ë”˜ ì˜í™” ë¦¬ë·° 100ê°œë¥¼ ìˆ˜ì§‘

# ì‹¤í–‰í• ë•Œ ì•„ë˜ì™€ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí•  ê²½ìš°ì—ëŠ” 
# read_html() -> read_html(options = "HUGE") ì´ë ‡ê²Œ ì•ˆì— options = "HUGE"ë¥¼ ì¤˜ì•¼í•©ë‹ˆë‹¤! 
# Error in doc_parse_raw(x, encoding = encoding, base_url = base_url, as_html = as_html,  : 
# Excessive depth in document: 256 use XML_PARSE_HUGE option


# (1) ê°€ì¥ ë§ì´ ì“°ì´ëŠ” ë‹¨ì–´ 10ê°œ ë§‰ëŒ€ê·¸ë˜í”„ ì‹œê°í™”
# (2) wordcloud2 ì‹œê°í™”


library(httr)
library(urltools)
library(rvest)
library(jsonlite)
library(dplyr)
library(stringr)


myUA <- 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36'

result<-data.frame()
'https://movie.naver.com/movie/bi/mi/review.nhn?code=163788'
'/movie/bi/mi/review.nhn?code=163788'
'/movie/bi/mi/review.nhn?code=163788&page=2'

for (i in 1:10){ #ëŒ“ê¸€ í˜ì´ì§€ ë²ˆí˜¸
  for(j in 1:10){ #ëŒ“ê¸€
    res <- GET(url = str_c('https://movie.naver.com/movie/bi/mi/review.nhn?code=163788
                           &page=',code[i]),
               query = list(page = j),
               user_agent(myUA))
    
    df<-res %>% content(as = 'text') %>% fromJSON()
    
    temp<-data.frame(title = str_c('ì•Œë¼ë”˜ ëŒ“ê¸€ í˜ì´ì§€',i),
                     review = df$comments$text)
    
    result <-rbind(result,temp)
    cat('í˜„ì¬ ',i,'í˜ì´ì§€, ëŒ“ê¸€ ', 10*j, 'ê°œ ìˆ˜ì§‘ì™„ë£Œ \n')
    
    Sys.sleep(0.5)
  }
}

View(result)

#############################
library(rJava)


# í…ìŠ¤íŠ¸ ë§ˆì´ë‹ ì‹œê°í™”
install.packages("wordcloud2")
install.packages("tm")
library(wordcloud2)
library(tm)

# Rì—ì„œ ë‹¤ì–‘í•œ ìƒ‰ê¹”ì„ ì„ íƒí•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬
library(RColorBrewer)


# í…ìŠ¤íŠ¸ ë§ˆì´ë‹ íŒ¨í‚¤ì§€
install.packages('C:/Program Files/NLP4kec~~~',
                 repos = NULL)
library(NLP4kec)


result$lyric %>%
  str_remove_all(pattern = '[a-z]')%>%
  str_remove_all(pattern = '[A-Z]')%>%
  str_remove_all(pattern = '[ã„±-ã…£]')%>%
  str_remove_all(pattern = '[0-9]')%>%
  str_remove_all(pattern = '[~!@#$%^&*()_+.\\n\;ğŸ¦ğŸºğŸ¦ŒğŸ‰]â¤ï¸')%>% #
  str_trim() %>%
  
  
  library(dplyr)
result<-result %>%
  dplyr::filter(review !='')


# í˜•íƒœì†Œ ë¶„ì„  
parse<-r_parser_r(contentVector = result$review, language = 'ko')

# ë§ë­‰ì¹˜(ìë£Œêµ¬ì¡°)ë¥¼ ìƒì„±
corpus<-parsed %>% VectorSource() %>%VCorpus()


# ê°ê°ì˜ ë¬¸ì„œ í™•ì¸
inspcet(corpus[1])

# ë‹¨ì–´ ë¬¸ì‚¬ í–‰ë ¬ ë§Œë“¤ê¸°
dtm<-DocumentTermMatrix(x=corpus,
                        control = list(wordLengths = c(2,Inf),
                                       stopwords=c('ì‘','ë„¤','ë„µ')))

# ì°¨ì›ì„ í™•ì¸í•©ë‹ˆë‹¤.
dim(dtm)
inspect(dtm)

dtm_remove<-removeSparseTerms(x=dtm, sparse=0.99)


# ì°¨ì›ì„ í™•ì¸í•©ë‹ˆë‹¤.
dim(dtm_remove)

# ë‹¨ì–´ ë¬¸ì„œ í–‰ë ¬ í™•ì¸
inspect(dtm_remove)

# í–‰ë ¬ë¡œ ë³€í™˜
mat<-as.matrix(dtm_remove)

# ë™ì‚¬ ì œê±°
colnames(mat)
mat2<-mat[, colnames(mat) %>% str_sub(-1) !="ë‹¤"]


# ì—´ì„ ê¸°ì¤€ìœ¼ë¡œ ë‹¨ì–´ì˜ ìˆ˜ í™•ì¸
# ì°¸ê³ )apply(ìë£Œêµ¬ì¡°, 1(í–‰) or 2(ì—´), ì‚¬ìš©í•  í•¨ìˆ˜)
word <- apply(mat2, 2, sum) %>% sort(decreasing = TRUE)


# data.frame()ìœ¼ë¡œ ë³€í™˜
df<-data.frame(word = names(word), freq=word)


# í–‰ ì´ë¦„ ë³€ê²½
rownames(df) <-seq(from=1, to=nrow(df), by=1)
df

#ë§‰ëŒ€ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
library(ggplot2)

df %>%
  arrange(desc(freq)) %>%
  head(10)%>%
  ggplot(mapping = aes(x=reorder(word,-freq), y=freq, fill=word)) +
  geom_bar(stat= "identity")


# ì‹œê°í™”
wordcloud2(df)
